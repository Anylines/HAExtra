#  小爱音箱文本朗读
- alias: MiAI Text To Speech
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_text.miai
  action:
    - condition: template
      value_template: "{{ states('input_text.miai') != 'unknown' and states('input_text.miai') != '' }}"
    - service: hello_miai.send
      data_template:
        message: "{{ states('input_text.miai') }}"

# 入户门开启
# - alias: Entrance Door Opened
#   initial_state: true
#   trigger:
#     platform: state
#     entity_id: binary_sensor.door_window_sensor_158d0001f3e5be
#     from: 'off'
#     to: 'on'
#   action:
#     service: hello_miai.send
#     data:
#       message: 欢迎光临

# 门铃开关单击
# - alias: Entrance Switch Clicked
#   trigger:
#     - platform: event
#       event_type: click
#       event_data:
#         entity_id: binary_sensor.switch_158d0001e59b33
#         click_type: single
#   action:
#     - service: hello_miai.send
#       data:
#         message: 叮咚，叮咚，有人按门铃啦

# 门铃开关双击
- alias: Entrance Switch Double Clicked
  trigger:
    - platform: event
      event_type: click
      event_data:
        entity_id: binary_sensor.switch_158d0001e59b33
        click_type: double
  action:
    - service: hello_miai.send
      data:
        message: 叮咚，叮咚，快开门啊

# 门铃开关长按
- alias: Entrance Switch Long Pressed
  trigger:
    - platform: event
      event_type: click
      event_data:
        entity_id: binary_sensor.switch_158d0001e59b33
        click_type: long_click_press
  action:
    - service: hello_miai.send
      data:
        message: 叮咚，叮咚，有人在家吗

# 无线开关单击
# - alias: Xiaomi Switch Clicked
#   trigger:
#     - platform: event
#       event_type: click
#       event_data:
#         entity_id: binary_sensor.switch_158d000201a73f
#         click_type: single
#   action:
#     - service: hello_miai.send
#       data:
#         message: 快过来

# 无线开关双击
# - alias: Xiaomi Switch Double Clicked
#   trigger:
#     - platform: event
#       event_type: click
#       event_data:
#         entity_id: binary_sensor.switch_158d000201a73f
#         click_type: double
#   action:
#     - service: hello_miai.send
#       data:
#         message: 双击无线开关

# # 无线开关长按
# - alias: Xiaomi Switch Long Pressed
#   trigger:
#     - platform: event
#       event_type: click
#       event_data:
#         entity_id: binary_sensor.switch_158d000201a73f
#         click_type: long_click_press
#   action:
#     - service: hello_miai.send
#       data:
#         message: 长按无线开关

# 阳台移门开合
- alias: Balcony Door Toggled
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d000228a52b
      from: 'off'
      to: 'on'
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d000228a52b
      from: 'on'
      to: 'off'
  condition:
    - condition: state
      entity_id: sun.sun
      state: below_horizon
  action:
    - service_template: "{% if is_state('binary_sensor.door_window_sensor_158d000228a52b', 'on') %}light.turn_on{% else %}light.turn_off{% endif %}"
      entity_id: light.hassmart4b

# 阳台移门打开
- alias: Balcony Door Opened
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d000228a52b
      from: 'off'
      to: 'on'
      for:
        minutes: 2
  action:
    - service: climate.turn_off
      entity_id: climate.daikin2
    - service: climate.turn_off
      entity_id: climate.daikin1
    - condition: numeric_state
      entity_id: sensor.phicomm_pm25
      below: 30
    - service: fan.turn_off
      entity_id: fan.fresher
    - service: fan.turn_off
      entity_id: fan.purifier
    - service: fan.turn_off
      entity_id: fan.diningroom_purifier

# 阳台移门关闭
- alias: Balcony Door Closed
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d000228a52b
      from: 'on'
      to: 'off'
  action:
    - service: fan.turn_on
      entity_id: fan.fresher
    - service: fan.turn_on
      entity_id: fan.purifier
    - service: fan.turn_on
      entity_id: fan.diningroom_purifier

# 洗手间灯感应开
- alias: Washroom Light On
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0001f4a238
      to: 'on'
  condition:
    # - condition: state
    #   entity_id: light.hassmart6a
    #   state: 'off'
    - condition: state
      entity_id: sun.sun
      state: below_horizon
  action:
    - service: light.turn_on
      entity_id: light.hassmart6a
    - service: automation.turn_off
      entity_id: automation.washroom_light_off
    - service: automation.turn_on
      entity_id: automation.washroom_light_off

# 洗手间灯延迟关
- alias: Washroom Light Off
  initial_state: false
  trigger:
    - platform: time
      minutes: '/5'
      seconds: 00
  condition:
    - condition: state
      entity_id: binary_sensor.motion_sensor_158d0001f4a238
      state: 'off'
  action:
    - service: light.turn_off
      entity_id: light.hassmart6a
    - service: automation.turn_off
      entity_id: automation.washroom_light_off

# 过道灯白天感应开
- alias: Passage Light On Day
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0001d66ce9
      to: 'on'
    - platform: state
      entity_id: device_tracker.yphone
      to: 'home'
    - platform: state
      entity_id: device_tracker.zphone
      to: 'home'
  condition:
    - condition: time
      after: '06:00'
      before: '18:00'
    - condition: numeric_state
      entity_id: sensor.illumination_34ce0090901a
      below: 300
  action:
    - service: light.turn_on
      entity_id: light.hassmart5a

# 过道灯白天感应关
- alias: Passage Light Off Day
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0001d66ce9
      to: 'off'
    - platform: state
      entity_id: device_tracker.yphone
      to: 'not_home'
    - platform: state
      entity_id: device_tracker.zphone
      to: 'not_home'
  condition:
    - condition: time
      after: '06:00'
      before: '18:00'
    - condition: state
      entity_id: binary_sensor.motion_sensor_158d0001d66ce9
      state: 'off'
    - condition: state
      entity_id: binary_sensor.motion_sensor_158d0001f4a238
      state: 'off'
    - condition: state
      entity_id: device_tracker.yphone
      state: 'not_home'
    - condition: state
      entity_id: device_tracker.zphone
      state: 'not_home'
    - condition: state
      entity_id: media_player.x9400e
      state: 'off'
  action:
    - service: light.turn_off
      entity_id: light.hassmart5a

# 过道灯白天变亮关
- alias: Passage Light Off Brighten
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.illumination_34ce0090901a
      above: 400
      for:
        minutes: 10
  condition:
    - condition: time
      after: '06:00'
      before: '18:00'
  action:
    - service: light.turn_off
      entity_id: light.hassmart5a

# 过道灯晚上感应开
- alias: Passage Light On Night
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0001d66ce9
      from: 'off'
      to: 'on'
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0001f3e5be
      from: 'off'
      to: 'on'
  condition:
    - condition: time
      after: '18:00'
      before: '21:30'
  action:
    - service: light.turn_on
      entity_id: light.hassmart5a

# 过道灯晚上感应关
- alias: Passage Light Off Night
  initial_state: true
  trigger:
    - platform: time
      at: '21:30:00'
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0001d66ce9
      to: 'off'
  condition:
    - condition: time
      after: '21:29'
      before: '23:59'
    - condition: state
      entity_id: binary_sensor.motion_sensor_158d0001d66ce9
      state: 'off'
    - condition: state
      entity_id: binary_sensor.motion_sensor_158d0001f4a238
      state: 'off'
    - condition: state
      entity_id: media_player.x9400e
      state: 'off'
  action:
    - service: light.turn_off
      entity_id: light.hassmart5a

# 过道背景灯感应开关
- alias: Passage Backlight Reaction
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0001d66ce9
      from: 'off'
      to: 'on'
  condition:
    - condition: time
      after: '21:30'
      before: '06:00'
    - condition: state
      entity_id: light.hassmart5a
      state: 'off'
    # - condition: state
    #   entity_id: light.sonoff1
    #   state: 'off'
  action:
    - service: light.turn_on
      entity_id: light.sonoff1
    - wait_template: "{{ is_state('binary_sensor.motion_sensor_158d0001d66ce9', 'off') }}"
    - service: light.turn_off
      entity_id: light.sonoff1

# 餐厅灯开关同步
- alias: Diningroom Light Sync
  initial_state: true
  trigger:
    - platform: state
      entity_id: light.hassmart1c, light.hassmart2a
  action:
    - service_template: >
        {% if trigger.to_state.state == 'on' %}
          light.turn_on
        {% else %}
          light.turn_off
        {% endif %}
      data_template:
        entity_id: >
          {% if trigger.entity_id == 'light.hassmart1c' %}
            light.hassmart2a
          {% else %}
            light.hassmart1c
          {% endif %}

# 客厅灯开关同步
- alias: Parlor Light Sync
  initial_state: true
  trigger:
    - platform: state
      entity_id: light.hassmart4a, light.hassmart3a
  action:
    - service_template: >
        {% if trigger.to_state.state == 'on' %}
          light.turn_on
        {% else %}
          light.turn_off
        {% endif %}
      data_template:
        entity_id: >
          {% if trigger.entity_id == 'light.hassmart4a' %}
            light.hassmart3a
          {% else %}
            light.hassmart4a
          {% endif %}

# 过道灯开关同步
- alias: Passage Light Sync
  initial_state: true
  trigger:
    - platform: state
      entity_id: light.sonoff1b, light.hassmart5a
  action:
    - service_template: >
        {% if trigger.to_state.state == 'on' %}
          light.turn_on
        {% else %}
          light.turn_off
        {% endif %}
      data_template:
        entity_id: >
          {% if trigger.entity_id == 'light.sonoff1b' %}
            light.hassmart5a
          {% else %}
            light.sonoff1b
          {% endif %}

# 书房灯开关同步
- alias: Study Light Sync
  initial_state: true
  trigger:
    - platform: state
      entity_id: light.hassmart5b, light.hassmart5c
  action:
    - service_template: >
        {% if trigger.to_state.state == 'on' %}
          light.turn_on
        {% else %}
          light.turn_off
        {% endif %}
      data_template:
        entity_id: >
          {% if trigger.entity_id == 'light.hassmart5b' %}
            light.hassmart5c
          {% else %}
            light.hassmart5b
          {% endif %}

# 阳台空气差
- alias: Balcony PM2.5 Bad
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.balcony_pm25
      above: 50
      for:
        minutes: 5
  condition:
    - condition: state
      entity_id: binary_sensor.door_window_sensor_158d000228a52b
      state: 'on'
  action:
    - service: hello_miai.send
      data:
        message: 外面空气很差，请关好门窗

# 阳台空气好
- alias: Balcony PM2.5 Good
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.balcony_pm25
      below: 20
      for:
        minutes: 10
  condition:
    - condition: state
      entity_id: binary_sensor.door_window_sensor_158d000228a52b
      state: 'off'
    # - condition: numberic_state
    #   entity_id: sensor.balcony_temperature
    #   below: 32
    - condition: or
      conditions:
        - condition: numeric_state
          entity_id: sensor.phicomm_pm25
          above: 20
        - condition: numeric_state
          entity_id: sensor.fresher_co2
          above: 700
  action:
    - service: hello_miai.send
      data:
        message: 外面空气很好，可以打开门窗

# 客厅空气警告
- alias: Parlor Air Warning
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.phicomm_pm25
      above: 40
    - platform: numeric_state
      entity_id: sensor.fresher_co2
      above: 900
    - platform: numeric_state
      entity_id: sensor.co2
      above: 900
    - platform: numeric_state
      entity_id: sensor.phicomm_hcho
      above: 0.08
  action:
    - service: light.turn_on
      data_template:
        entity_id: light.gateway_light_34ce0090901a
        rgb_color: ["{% if states('sensor.co2') | int > 900 %}128{% else %}0{% endif %}","{% if states('sensor.phicomm_hcho') | float > 0.08 %}255{% else %}0{% endif %}","{% if states('sensor.phicomm_pm25') | int > 40 %}255{% else %}0{% endif %}"]
        brightness: 10

# 客厅空气达标
- alias: Parlor Air Restored
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.phicomm_pm25
      below: 40
    - platform: numeric_state
      entity_id: sensor.fresher_co2
      below: 900
    - platform: numeric_state
      entity_id: sensor.co2
      below: 900
    - platform: numeric_state
      entity_id: sensor.phicomm_hcho
      below: 0.08
  condition:
    - condition: numeric_state
      entity_id: sensor.phicomm_pm25
      below: 40
    - condition: numeric_state
      entity_id: sensor.fresher_co2
      below: 900
    - condition: numeric_state
      entity_id: sensor.co2
      below: 900
    - condition: numeric_state
      entity_id: sensor.phicomm_hcho
      below: 0.08
  action:
    - service: light.turn_off
      entity_id: light.gateway_light_34ce0090901a

# 客厅湿度超标
- alias: Parlor Humidity Bad
  initial_state: false
  trigger:
    - platform: numeric_state
      entity_id: sensor.phicomm_humidity
      above: 66
      for:
        minutes: 10
  action:
    - service: switch.turn_on
      entity_id: switch.outlet

# 客厅湿度恢复
- alias: Parlor Humidity Good
  initial_state: false
  trigger:
    - platform: numeric_state
      entity_id: sensor.phicomm_humidity
      below: 64
      for:
        minutes: 10
  action:
    - service: switch.turn_off
      entity_id: switch.outlet

# 客厅空气差
- alias: Parlor PM2.5 Bad
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.fresher_pm25
      above: 20
      for:
        minutes: 5
    - platform: numeric_state
      entity_id: sensor.phicomm_pm25
      above: 20
      for:
        minutes: 5
  action:
    - service: fan.turn_on
      entity_id: fan.fresher
    - service: fan.turn_on
      entity_id: fan.diningroom_purifier
    - service: fan.set_speed
      data:
        entity_id: fan.fresher
        speed: strong
    - service: fan.set_speed
      data_template:
        entity_id: fan.diningroom_purifier
        speed: "{% if states('sensor.phicomm_pm25') | int > 40 %}high{% else %}medium{% endif %}"
    - condition: numeric_state
      entity_id: sensor.fresher_pm25
      above: 40
    - condition: state
      entity_id: binary_sensor.door_window_sensor_158d000228a52b
      state: 'on'
    - service: hello_miai.send
      data:
        message: 室内空气差，启动净化器和新风机，请关好门窗

# 客厅空气好
- alias: Parlor PM2.5 Good
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.phicomm_pm25
      below: 15
      for:
        minutes: 5
  action:
    - service: fan.set_speed
      data:
        entity_id: fan.diningroom_purifier
        speed: low
    - condition: numeric_state
      entity_id: sensor.fresher_co2
      below: 675
    - service: fan.set_speed
      data:
        entity_id: fan.fresher
        speed: low

# 客厅空气闷
- alias: Parlor CO2 Bad
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.fresher_co2
      above: 725
      for:
        minutes: 5
  # condition:
  #   - condition: state
  #     entity_id: binary_sensor.door_window_sensor_158d000228a52b
  #     state: 'off'
  action:
    - service: fan.turn_on
      entity_id: fan.fresher
    - service: fan.set_speed
      data:
        entity_id: fan.fresher
        speed: strong

# 客厅空气新鲜
- alias: Parlor CO2 Good
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.phicomm_co2
      below: 675
      for:
        minutes: 5
  condition:
    - condition: numeric_state
      entity_id: sensor.phicomm_pm25
      below: 20
    - condition: state
      entity_id: fan.fresher
      state: 'on'
  action:
    - service: fan.set_speed
      data:
        entity_id: fan.fresher
        speed: auto

# 书房空气差
- alias: Study PM2.5 Bad
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.purifier_pm25
      above: 25
      for:
        minutes: 5
  action:
    - service: fan.turn_on
      entity_id: fan.purifier
    - service: fan.set_speed
      data:
       entity_id: fan.purifier
       speed: favorite
    - service: fan.xiaomi_miio_set_favorite_level
      data:
       entity_id: fan.purifier
       level: 7
    - condition: time
      after: '18:00'
      before: '22:00'
    - service: fan.turn_on
      entity_id: fan.parents_purifier
    - service: fan.set_speed
      data:
       entity_id: fan.parents_purifier
       speed: high

# 书房空气好
- alias: Study PM2.5 Good
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.purifier_pm25
      below: 20
      for:
        minutes: 5
  action:
    - service: fan.set_speed
      data:
       entity_id: fan.purifier
       speed: auto
    - service: fan.set_speed
      data:
       entity_id: fan.parents_purifier
       speed: low

# 主卧空气差
- alias: Bedroom PM2.5 Bad
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.pm25
      above: 20
      for:
        minutes: 5
  action:
    - service: fan.turn_on
      entity_id: fan.bedroom_purifier
    - service: fan.set_speed
      data:
       entity_id: fan.bedroom_purifier
       speed: medium
    - condition: time
      after: '18:00'
      before: '22:00'
    - service: fan.set_speed
      data:
       entity_id: fan.bedroom_purifier
       speed: high

# 主卧空气好
- alias: Bedroom PM2.5 Good
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.pm25
      below: 15
      for:
        minutes: 5
  action:
    - service: fan.set_speed
      data:
       entity_id: fan.bedroom_purifier
       speed: low
